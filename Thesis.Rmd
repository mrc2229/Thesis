---
title: "Thesis"
author: "Matthew Curran"
date: "January 15, 2020"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(janitor)
library(rvest)
library(viridis)
library(broom)
library(knitr)
library(foreign)
library(Hmisc)
library(arsenal)
library(MatchIt)
library(mice)
library(stats)
library(MASS)
```

# Data from NHANES

```{r alcohol data, echo=FALSE}
alc_data = sasxport.get("./data/ALQ_I.XPT")
write.csv(alc_data, file="ALQ_I.csv") 

alc_data = alc_data %>%
  janitor::clean_names() %>%
  dplyr::select(seqn, alq160, alq101)
```

```{r sleep data, echo=FALSE}
sleep_data = sasxport.get("./data/SLQ_I.XPT")
write.csv(sleep_data, file="SLQ_I.csv")

sleep_data = sleep_data %>%
  janitor::clean_names() %>%
  dplyr::select(seqn, slq040)
```

```{r demographic data, echo=FALSE}
demo_data = sasxport.get("./data/Demo_I.XPT")
write.csv(demo_data, file="DEMO_I.csv")

demo_data = demo_data %>%
  janitor::clean_names()%>%
  dplyr::select(seqn, riagendr, ridageyr, ridreth3, dmdmartl)
```

```{r weight data, echo=FALSE}
weight_data = sasxport.get("./data/BMX_I.XPT")
write.csv(weight_data, file="BMX_I.csv")

weight_data = weight_data %>%
  janitor::clean_names() %>%
  dplyr::select(seqn, bmxbmi)
```

```{r make final dataset}
thesis_data = 
  left_join(alc_data, sleep_data, by = "seqn")

thesis_data = 
  left_join(thesis_data, demo_data, by = "seqn")

thesis_data = 
  left_join(thesis_data, weight_data, by = "seqn")
```

```{r data cleaning}
thesis_data_clean = thesis_data %>%
  rename(gender=riagendr, drinker=alq101, binge_drinker=alq160, apnea=slq040, age=ridageyr, race=ridreth3, martstat=dmdmartl, bmi=bmxbmi) %>%
  filter(age == 18|age == 19|age == 20|age == 21|age == 22|age == 23|age == 24| age == 25) %>%
  mutate(binge_drinker=as.numeric(binge_drinker)) %>%
  mutate(binge_drinker =
         recode(binge_drinker,
           "0" = "FALSE",
           "1" = "TRUE", "2" = "TRUE", "3" = "TRUE", "4" = "TRUE",
           "5" = "TRUE", "6" = "TRUE", "7" = "TRUE", "8" = "TRUE",
           "9" = "TRUE", "10" = "TRUE","11" = "TRUE", "12" = "TRUE",
           "13" = "TRUE", "14" = "TRUE", "15" = "TRUE", "16" = "TRUE",
           "17" = "TRUE", "18" = "TRUE","20" = "TRUE",
           "777" = "Refused",
           "999" = "Don't Know"
         )) %>%
   mutate(drinker=as.numeric(drinker)) %>%
   mutate(drinker =
         recode(drinker,
           "1" = "TRUE",
           "2" = "FALSE",
           "7" = "Refused",
           "9" = "Don't Know"
         )) %>%
   mutate(apnea=as.numeric(apnea)) %>%
   mutate(apnea =
         recode(apnea,
           "0" = "FALSE",
           "1" = "FALSE",
           "2" = "TRUE",
           "3" = "TRUE",
           "7" = "Refused",
           "9" = "Don't Know"
         )) %>%
   mutate(gender=as.numeric(gender)) %>%
   mutate(gender =
         recode(gender,
           "1" = "Male",
           "2" = "Female"
         ))%>%
   mutate(race=as.numeric(race)) %>%
   mutate(race =
         recode(race,
           "1" = "Mexican American",
           "2" = "Other Hispanic",
           "3" = "White",
           "4" = "Black",
           "6" = "Asian",
           "7" = "Other Race or Multi-Racial"
         )) %>%
   mutate(martstat=as.factor(martstat)) %>%
   mutate(martstat =
         recode(martstat,
           "1" = "Married, Previously Married, or Living with Partner",
           "2" = "Married, Previously Married, or Living with Partner",
           "3" = "Married, Previously Married, or Living with Partner",
           "4" = "Married, Previously Married, or Living with Partner",
           "5" = "Never Married and does not Live with Partner",
           "6" = "Married, Previously Married, or Living with Partner",
           "77" = "Refused",
           "99" = "Don't Know"
         )) %>%
  filter(drinker != "Don't Know") %>%
  mutate(drinker = fct_explicit_na(drinker, na_level = "Missing")) %>%
  filter(apnea != "Don't Know") %>%
  mutate(apnea = fct_explicit_na(apnea, na_level = "Missing")) %>%
  mutate(binge_drinker = fct_explicit_na(binge_drinker, na_level = "Missing")) %>%
mutate(drinker=as.logical(drinker)) %>%
  mutate(apnea=as.logical(apnea)) %>%
  mutate(binge_drinker=as.logical(binge_drinker)) %>%
  mutate(age=as.numeric(age)) %>%
  mutate(martstat=as.factor(martstat)) %>%
  mutate(race=as.factor(race)) %>%
  mutate(gender=as.factor(gender))
```

```{r table 1 making, results='asis'}
table_one = tableby(drinker ~age + gender + race + martstat + bmi, data=thesis_data_clean)
summary(table_one)
```

```{r table 2 making, results='asis'}
table_two_data = thesis_data_clean [!(thesis_data_clean$drinker=="No"),]

table_two = tableby(binge_drinker ~age + gender + race + martstat + bmi, data=table_two_data)
summary(table_two)
```

```{r imputation, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
imputed_data = mice(thesis_data_clean,m=5,maxit=50,meth='pmm',seed=500)
summary(imputed_data)

imputed_data_1 = complete(imputed_data, action = 1, include = FALSE)
imputed_data_2 = complete(imputed_data, action = 2, include = FALSE)
imputed_data_3 = complete(imputed_data, action = 3, include = FALSE)
imputed_data_4 = complete(imputed_data, action = 4, include = FALSE)
imputed_data_5 = complete(imputed_data, action = 5, include = FALSE)

imputed_data_all = list(imputed_data_1, imputed_data_2, imputed_data_3, imputed_data_4, imputed_data_5)
#complete with all 5 imputed sets
```

* Use stepAIC in stats package to check interaction terms. Did this both as a function and not.
# Ask which is prefered, or if both are wrong.

```{r}
aic_check = function(y){
mult_linear_1 = lm(drinker ~ age + bmi + gender + race + martstat, data = y)

interact_check = stepAIC(mult_linear_1, scope=list(upper= ~age*bmi*gender*race*martstat, lower= ~1),
        direction = c("both"))
}

aic_drinker = lapply (imputed_data_all, aic_check)
```

* looks like best model is drinker ~ age + bmi + gender + race according to stepAIC

```{r}
mult_linear_2 = lm(binge_drinker ~ age + bmi + gender + race + martstat, data = imputed_data_2)

interact_check = stepAIC(mult_linear_2, scope=list(upper= ~age*bmi*gender*race*martstat, lower= ~1),
        direction = c("both"))
```

* looks like best model is binge_drinker ~ age + gender + race + martstat + age:gender according to stepAIC

```{r}
mult_linear_3 = lm(apnea ~ age + bmi + gender + race + martstat, data = imputed_data_3)

interact_check = stepAIC(mult_linear_3, scope=list(upper= ~age*bmi*gender*race*martstat, lower= ~1),
        direction = c("both"))
```

* The best outcome model according to step AIC is apnea ~ race + martstat + race:martstat

# Use Lapply to run prop_score for each individual dataset. Want function to save weights
```{r propensity score}
pscore = function(x){
ps<-matchit(drinker ~  age + bmi + gender + race + bmi*gender, data = x, 
                 method = "full", 
                 replace=TRUE, discard = "both",
                exact=c("gender", "martstat", "race"),
                 mahvars = c("bmi","age"), 
                 caliper=.2, 
                 reestimate=FALSE)

  return(ps$weights)
}

prop_score = lapply (imputed_data_all, pscore)

summary(prop_score)

weights = do.call(rbind, prop_score)

summary(weights)

plot(prop_score, type="jitter")
```

#Grab matched data - weights
```{r, matching and summary}
library(mitools)

ps_data = MIcombine(weights)
```

look into outcome regression with these weights