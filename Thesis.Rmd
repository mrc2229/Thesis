---
title: "Thesis"
author: "Matthew Curran"
date: "January 15, 2020"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(janitor)
library(rvest)
library(viridis)
library(broom)
library(knitr)
library(foreign)
library(Hmisc)
library(arsenal)
library(MatchIt)
library(mice)
library(stats)
library(MASS)
library(ggplot2)
library(cobalt)
library(mitools)
```

# Data from NHANES

```{r alcohol data, echo=FALSE}
alc_data = sasxport.get("./data/ALQ_I.XPT")
write.csv(alc_data, file="ALQ_I.csv") 

alc_data = alc_data %>%
  janitor::clean_names() %>%
  dplyr::select(seqn, alq160, alq101)
```

```{r sleep data, echo=FALSE}
sleep_data = sasxport.get("./data/SLQ_I.XPT")
write.csv(sleep_data, file="SLQ_I.csv")

sleep_data = sleep_data %>%
  janitor::clean_names() %>%
  dplyr::select(seqn, slq040)
```

```{r demographic data, echo=FALSE}
demo_data = sasxport.get("./data/Demo_I.XPT")
write.csv(demo_data, file="DEMO_I.csv")

demo_data = demo_data %>%
  janitor::clean_names()%>%
  dplyr::select(seqn, riagendr, ridageyr, ridreth3, dmdmartl)
```

```{r weight data, echo=FALSE}
weight_data = sasxport.get("./data/BMX_I.XPT")
write.csv(weight_data, file="BMX_I.csv")

weight_data = weight_data %>%
  janitor::clean_names() %>%
  dplyr::select(seqn, bmxbmi)
```

```{r make final dataset}
thesis_data = 
  left_join(alc_data, sleep_data, by = "seqn")

thesis_data = 
  left_join(thesis_data, demo_data, by = "seqn")

thesis_data = 
  left_join(thesis_data, weight_data, by = "seqn")
```

```{r data cleaning}
thesis_data_clean = thesis_data %>%
  rename(gender=riagendr, drinker=alq101, binge_drinker=alq160, apnea=slq040, age=ridageyr, race=ridreth3, martstat=dmdmartl, bmi=bmxbmi) %>%
  filter(age == 18|age == 19|age == 20|age == 21|age == 22|age == 23|age == 24| age == 25) %>%
  mutate(binge_drinker=as.numeric(binge_drinker)) %>%
  mutate(binge_drinker =
         recode(binge_drinker,
           "0" = "0",
           "1" = "1", "2" = "1", "3" = "1", "4" = "1",
           "5" = "1", "6" = "1", "7" = "1", "8" = "1",
           "9" = "1", "10" = "1","11" = "1", "12" = "1",
           "13" = "1", "14" = "1", "15" = "1", "16" = "1",
           "17" = "1", "18" = "1","20" = "1",
           "777" = "Refused",
           "999" = "Don't Know"
         )) %>%
   mutate(drinker=as.numeric(drinker)) %>%
   mutate(drinker =
         recode(drinker,
           "1" = "1",
           "2" = "0",
           "7" = "Refused",
           "9" = "Don't Know"
         )) %>%
   mutate(apnea=as.numeric(apnea)) %>%
   mutate(apnea =
         recode(apnea,
           "0" = "0",
           "1" = "0",
           "2" = "1",
           "3" = "1",
           "7" = "Refused",
           "9" = "Don't Know"
         )) %>%
   mutate(gender=as.numeric(gender)) %>%
   mutate(gender =
         recode(gender,
           "1" = "1",
           "2" = "0"
         ))%>%
   mutate(race=as.numeric(race)) %>%
   mutate(race =
         recode(race,
           "1" = "Mexican American",
           "2" = "Other Hispanic",
           "3" = "White",
           "4" = "Black",
           "6" = "Asian",
           "7" = "Other Race or Multi-Racial"
         )) %>%
   mutate(martstat=as.factor(martstat)) %>%
   mutate(martstat =
         recode(martstat,
           "1" = "1",
           "2" = "1",
           "3" = "1",
           "4" = "1",
           "5" = "0",
           "6" = "1",
           "77" = "Refused",
           "99" = "Don't Know"
         )) %>%
  filter(drinker != "Don't Know") %>%
  mutate(drinker = fct_explicit_na(drinker, na_level = "Missing")) %>%
  filter(apnea != "Don't Know") %>%
  mutate(apnea = fct_explicit_na(apnea, na_level = "Missing")) %>%
  mutate(binge_drinker = fct_explicit_na(binge_drinker, na_level = "Missing")) %>%
  mutate(age=as.numeric(age)) %>%
  mutate(martstat=as.factor(martstat)) %>%
  mutate(race=as.factor(race)) %>%
  mutate(gender=as.factor(gender))
```

```{r table 1 making, results='asis'}
table_one = tableby(drinker ~age + gender + race + martstat + bmi, data=thesis_data_clean)
summary(table_one)
```

```{r table 2 making, results='asis'}
table_two_data = thesis_data_clean [!(thesis_data_clean$drinker=="0"),]

table_two = tableby(binge_drinker ~age + gender + race + martstat + bmi, data=table_two_data)
summary(table_two)
```

```{r imputation, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
imputed_data = mice(thesis_data_clean,m=5,maxit=50,meth='pmm',seed=500)
summary(imputed_data)

imputed_data_1 = complete(imputed_data, action = 1, include = FALSE)
imputed_data_2 = complete(imputed_data, action = 2, include = FALSE)
imputed_data_3 = complete(imputed_data, action = 3, include = FALSE)
imputed_data_4 = complete(imputed_data, action = 4, include = FALSE)
imputed_data_5 = complete(imputed_data, action = 5, include = FALSE)

imputed_data_all = list(imputed_data_1, imputed_data_2, imputed_data_3, imputed_data_4, imputed_data_5)
#complete with all 5 imputed sets
```

* Use stepAIC in stats package to check interaction terms. 

```{r}
mult_linear_1 = lm(drinker ~ age + bmi + gender + race + martstat, data = imputed_data_1)

interact_check = stepAIC(mult_linear_1, scope=list(upper= ~age*bmi*gender*race*martstat, lower= ~1),
        direction = c("forward"))
```

* looks like best model is drinker ~ age + bmi + gender + race + bmi:gender according to stepAIC

```{r}
binge_data_1= imputed_data_1 [!(imputed_data_1$drinker=="0"),]

mult_linear_2 = lm(binge_drinker ~ age + bmi + gender + race + martstat, data = binge_data_1)

interact_check = stepAIC(mult_linear_2, scope=list(upper= ~age*bmi*gender*race*martstat, lower= ~1),
        direction = c("both"))
```

* looks like best model is binge_drinker ~ age + bmi + race + martstat + bmi:martstat according to stepAIC

```{r}
mult_linear_3 = lm(apnea ~ age + bmi + gender + race + martstat + drinker, data = imputed_data_1)

interact_check = stepAIC(mult_linear_3, scope=list(upper= ~age*bmi*gender*race*martstat*drinker, lower= ~1),
        direction = c("both"))
```

* The best outcome model according to step AIC is apnea ~ race + martstat + race:martstat

```{r}
mult_linear_4 = lm(apnea ~ age + bmi + gender + race + martstat + binge_drinker, data = binge_data_1)

interact_check = stepAIC(mult_linear_4, scope=list(upper= ~age*bmi*gender*race*martstat*binge_drinker, lower= ~1),
        direction = c("both"))
```

* The best outcome model according to step AIC is apnea ~ bmi + race + martstat + binge_drinker


# Use Lapply to run prop_score for each individual dataset. Want function to save weights
```{r propensity score}
pscore = function(x){
ps = matchit(drinker ~  age + bmi + gender + race + bmi:gender, data = x, 
                 method = "full", 
                 replace=TRUE, discard = "both",
                exact=c("gender", "martstat", "race"),
                 mahvars = c("bmi","age"), 
                 caliper=.2, 
                 reestimate=FALSE)

return(ps$weights)
}

prop_score = lapply (imputed_data_all, pscore)

summary(prop_score)
```

# Check balance of the covariates with plots 
* Could not get to work in function for some reason, so ran each individually
```{r}
#Imputed Data 1
love_test_1 = matchit(drinker ~  age + bmi + gender + race + bmi:gender, data = imputed_data_1, 
                 method = "full", 
                 replace=TRUE, discard = "both",
                exact=c("gender", "martstat", "race"),
                 mahvars = c("bmi","age"), 
                 caliper=.2, 
                 reestimate=FALSE)

love.plot(love_test_1) 

#Imputed Data 2
love_test_2 = matchit(drinker ~  age + bmi + gender + race + bmi:gender, data = imputed_data_2, 
                 method = "full", 
                 replace=TRUE, discard = "both",
                exact=c("gender", "martstat", "race"),
                 mahvars = c("bmi","age"), 
                 caliper=.2, 
                 reestimate=FALSE)

love.plot(love_test_2) 

#Imputed Data 3
love_test_3 = matchit(drinker ~  age + bmi + gender + race + bmi:gender, data = imputed_data_3, 
                 method = "full", 
                 replace=TRUE, discard = "both",
                exact=c("gender", "martstat", "race"),
                 mahvars = c("bmi","age"), 
                 caliper=.2, 
                 reestimate=FALSE)

love.plot(love_test_3) 

#Imputed Data 4
love_test_4 = matchit(drinker ~  age + bmi + gender + race + bmi:gender, data = imputed_data_4, 
                 method = "full", 
                 replace=TRUE, discard = "both",
                exact=c("gender", "martstat", "race"),
                 mahvars = c("bmi","age"), 
                 caliper=.2, 
                 reestimate=FALSE)

love.plot(love_test_4) 

#Imputed Data 5
love_test_5 = matchit(drinker ~  age + bmi + gender + race + bmi:gender, data = imputed_data_5, 
                 method = "full", 
                 replace=TRUE, discard = "both",
                exact=c("gender", "martstat", "race"),
                 mahvars = c("bmi","age"), 
                 caliper=.2, 
                 reestimate=FALSE)

love.plot(love_test_5) 
```

# GLM using weights for the outcome model, for each imputed data set 
```{r}
outcome_fun = function(z){
outcome_fun_1 = function(y) {
outcome_lm_1 = glm(apnea ~ race + martstat + race:martstat + drinker, family = quasibinomial(), data=z, weights= y)
}

outcome_1 = lapply(prop_score, outcome_fun_1)

summary(MIcombine(outcome_1))

}

outcome_all = lapply(imputed_data_all, outcome_fun)

#summary(MIcombine(outcome_all))
```

# Also try running each set separately. 
#Not working
```{r}
outcome_glm_1 = glm(apnea ~ race + martstat + race:martstat + drinker, family = quasibinomial(), data=imputed_data_1, weights= prop_score[[1]])

#summary(imputed_data_1$apnea)

summary(MIcombine(outcome_glm_1))

#summary(MIcombine(outcome_all))
```

# GLM using weights for the outcome model, for each imputed data set. Binge Drinking.
```{r}
#create a list from imputed data to exclude non-drinkers
create_binge_data = function(b){
  binge_data_list = b[!(b$drinker=="0"),]
}

binge_data_all = lapply(imputed_data_all, create_binge_data)

#Weights for binge drinkers
pscore_binge = function(x){
ps_binge = matchit(binge_drinker ~ age + bmi + race + martstat + bmi:martstat, data = x, 
                 method = "full", 
                 replace=TRUE, discard = "both",
                exact=c("gender", "martstat", "race"),
                 mahvars = c("bmi","age"), 
                 caliper=.2, 
                 reestimate=FALSE)

return(ps_binge$weights)
}

prop_score_binge = lapply (binge_data_all, pscore_binge)

#outcomes with binge drinking
outcome_fun_binge = function(z){
outcome_fun_binge = function(y) {
outcome_lm_binge =
  glm(apnea ~ bmi + race + martstat + binge_drinker, family = quasibinomial(), data=z, weights= y)
}

outcome_1 = lapply(prop_score_binge, outcome_fun_binge)

summary(MIcombine(outcome_1))

}

outcome_all_binge = lapply(binge_data_all, outcome_fun_binge)

#summary(MIcombine(outcome_all_binge))
```


# Need to exponentiate the results
# Add logical covariates, even if not outputted from StepAIC
# After changing outcomes from logical to numeric, StepAIC not working properly,
# MIcombine still not working in running individual imputed sets