---
title: "Thesis"
author: "Matthew Curran"
date: "January 15, 2020"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(janitor)
library(rvest)
library(viridis)
library(broom)
library(knitr)
library(foreign)
library(Hmisc)
library(arsenal)
library(MatchIt)
library(mice)
```

# Data from NHANES

```{r alcohol data, echo=FALSE}
alc_data = sasxport.get("./data/ALQ_I.XPT")
write.csv(alc_data, file="ALQ_I.csv") 

alc_data = alc_data %>%
  janitor::clean_names() %>%
  select(seqn, alq160, alq101)
```

```{r sleep data, echo=FALSE}
sleep_data = sasxport.get("./data/SLQ_I.XPT")
write.csv(sleep_data, file="SLQ_I.csv")

sleep_data = sleep_data %>%
  janitor::clean_names() %>%
  select(seqn, slq040)
```

```{r demographic data, echo=FALSE}
demo_data = sasxport.get("./data/Demo_I.XPT")
write.csv(demo_data, file="DEMO_I.csv")

demo_data = demo_data %>%
  janitor::clean_names()%>%
  select(seqn, riagendr, ridageyr, ridreth3, dmdeduc3, dmdeduc2, indhhin2, indfmin2, dmdmartl)
```

```{r weight data, echo=FALSE}
weight_data = sasxport.get("./data/BMX_I.XPT")
write.csv(weight_data, file="BMX_I.csv")

weight_data = weight_data %>%
  janitor::clean_names() %>%
  select(seqn, bmxbmi)
```

```{r make final dataset}
thesis_data = 
  left_join(alc_data, sleep_data, by = "seqn")

thesis_data_demo = 
  left_join(thesis_data, demo_data, by = "seqn")

thesis_data_demo = 
  left_join(thesis_data_demo, weight_data, by = "seqn")
```

```{r data cleaning}
thesis_data_demo_clean = thesis_data_demo %>%
  rename(gender=riagendr, drinker=alq101, binge_drinker=alq160, apnea=slq040, age=ridageyr, race=ridreth3, education_20=dmdeduc2, education_19=dmdeduc3, hhinc=indhhin2, faminc=indfmin2, martstat=dmdmartl, bmi=bmxbmi) %>%
  filter(age == 18|age == 19|age == 20|age == 21|age == 22|age == 23|age == 24| age == 25) %>%
  mutate(education = coalesce(education_20, education_19)) %>%
  select(-education_19,-education_20) %>%
  mutate(binge_drinker=as.numeric(binge_drinker)) %>%
  mutate(binge_drinker =
         recode(binge_drinker,
           "0" = "No",
           "1" = "Yes", "2" = "Yes", "3" = "Yes", "4" = "Yes",
           "5" = "Yes", "6" = "Yes", "7" = "Yes", "8" = "Yes",
           "9" = "Yes", "10" = "Yes","11" = "Yes", "12" = "Yes",
           "13" = "Yes", "14" = "Yes", "15" = "Yes", "16" = "Yes",
           "17" = "Yes", "18" = "Yes","20" = "Yes",
           "777" = "Refused",
           "999" = "Don't Know"
         )) %>%
   mutate(drinker=as.numeric(drinker)) %>%
   mutate(drinker =
         recode(drinker,
           "1" = "Yes",
           "2" = "No",
           "7" = "Refused",
           "9" = "Don't Know"
         )) %>%
   mutate(apnea=as.numeric(apnea)) %>%
   mutate(apnea =
         recode(apnea,
           "0" = "No",
           "1" = "No",
           "2" = "Yes",
           "3" = "Yes",
           "7" = "Refused",
           "9" = "Don't Know"
         )) %>%
   mutate(gender=as.numeric(gender)) %>%
   mutate(gender =
         recode(gender,
           "1" = "Male",
           "2" = "Female"
         ))%>%
   mutate(race=as.numeric(race)) %>%
   mutate(race =
         recode(race,
           "1" = "Mexican American",
           "2" = "Other Hispanic",
           "3" = "White",
           "4" = "Black",
           "6" = "Asian",
           "7" = "Other Race or Multi-Racial"
         )) %>%
   mutate(martstat=as.factor(martstat)) %>%
   mutate(martstat =
         recode(martstat,
           "1" = "Married, Previously Married, or Living with Partner",
           "2" = "Married, Previously Married, or Living with Partner",
           "3" = "Married, Previously Married, or Living with Partner",
           "4" = "Married, Previously Married, or Living with Partner",
           "5" = "Never Married and does not Live with Partner",
           "6" = "Married, Previously Married, or Living with Partner",
           "77" = "Refused",
           "99" = "Don't Know"
         )) %>%
  filter(drinker != "Don't Know") %>%
  mutate(drinker = fct_explicit_na(drinker, na_level = "Missing")) %>%
  mutate(binge_drinker = fct_explicit_na(binge_drinker, na_level = "Missing")) 
```

```{r table 1 making, results='asis'}
table_one = tableby(drinker ~age + gender + race + martstat + bmi, data=thesis_data_demo_clean)
summary(table_one)
```

```{r table 2 making, results='asis'}
table_two_data = thesis_data_demo_clean [!(thesis_data_demo_clean$drinker=="No"),]

table_two = tableby(binge_drinker ~age + gender + race + martstat + bmi, data=table_two_data)
summary(table_two)
```

```{r imputation}
imputed_data = mice(thesis_data_demo_clean,m=5,maxit=50,meth='pmm',seed=500)
summary(imputed_data)
imputed_data <- complete(imputed_data)
```

```{r propensity score}
prop_score = matchit(drinker ~ factor(gender) + age + factor(race) + factor(martstat) + bmi, data = imputed_data, 
                 method = "full", 
                 replace=TRUE, discard = discard,
                 exact=c("gender", "martstat", "race"),
                 mahvars = c("bmi", "age"), 
                 caliper=0.2, 
                 reestimate=FALSE)
```

#Fit propensity score matching
  if(dichotomize != "none"){
    ps = matchit(noise ~ SEXF + age + factor(racecat) + Language + 
                   lninc + ImgGen + poly(mage,2) + fath + moth + meducat + 
                   pc_psych_minor + pp_pa_minor + pp_pa_severe + 
                   pc_pa_minor + pc_pa_severe + CH33 + factor(emp) + score + 
                   factor(Pmarital_4cat) + factor(region) + no2_2000 +
                   factor(religion) + citizen +  ndvi01 + tmax_mean + 
                   popden, data = dt2, 
                 method = "full", 
                 replace=TRUE, discard=discard, 
                 #exact=c("SEXF", "urbancat", "suburb"), 
                 exact=c("SEXF"),
                 mahvars = c("score", "lninc"), 
                 caliper=0.2, 
                 reestimate=FALSE)
    
#Grab matched data
  psData = match.data(ps)
  #Grab propensity scores
  if(discard != "none"){
  pscore = ps$distance[!ps$discarded]
  }
  else{
  pscore = ps$distance
  }